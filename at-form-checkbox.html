<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../at-core-theme/at-core-theme.html" />
<script src="util.js"></script>

<dom-module id="at-form-checkbox">
  <link rel="stylesheet" href="at-form-checkbox.css" />
  <template>
    <at-core-theme></at-core-theme>
    <div id="uiCheckbox" class="ui checkbox">
      <input id="input" type="checkbox" name="{{name}}">
      <label id="label">{{label}}</label>
    </div>
  </template>
</dom-module>

<script>
  "use strict";
  Polymer({
    is: "at-form-checkbox",
    properties: {
      name: {
        type: String,
        value: ''
      },
      label: {
        type: String,
        value: ''
      },
      disabled: {
        type: Boolean,
        value: false,
        reflect: true,
        observer: 'disabledChanged'
      },
      toggle: {
        type: Boolean,
        value: false
      },
      slider: {
        type: Boolean,
        value: false
      },
      value: {
        type: String,
        value: "false",
        reflect: true,
        observer: 'valueChanged'
      }
    },
    _moduleInstance: undefined,
    valueChanged: function (newValue, oldValue) {
      if (this.value === "true") {
        if (this._moduleInstance !== undefined) {
          this._moduleInstance.check();
        }
      } else if (this.value === "false") {
        if (this._moduleInstance !== undefined) {
          this._moduleInstance.uncheck();
        }
      }
      this.fire('change', this.value);
    },
    disabledChanged: function (newValue, oldValue) {
      if (this.disabled) {
        if (this._moduleInstance !== undefined) {
          this._moduleInstance.disable();
        }
      } else {
        if (this._moduleInstance !== undefined) {
          this._moduleInstance.enable();
        }
      }
    },
    ready: function () {
      if (this.toggle) {
        this.$.uiCheckbox.classList.add('toggle');
      }
      if (this.slider) {
        this.$.uiCheckbox.classList.add('slider');
      }
      var _self = this;
      var settings = {
        onChecked: function () {
          _self.value = "true";
        },
        onUnchecked: function () {
          _self.value = "false";
        }
      };

      if (this.value === "true") {
        this.$.input.setAttribute('checked', 'true');
      }

      this._moduleInstance = new atFormCheckbox(this, settings);

      // set disabled if element is disabled
      if (this.disabled) {
        this._moduleInstance.disable();
      }

      this.valueChanged(this.value, this.value);
    }
  });

  (function (window, document, dataInterface, undefined) {
    "use strict";

    var module = window.atFormCheckbox = function (polymerElement, userSettings) {
      var settings = this.settings = atFormCheckboxUtil.extend(true, {}, atFormCheckbox.settings, userSettings);

      var className = this.className = settings.className;
      var namespace = settings.namespace;
      var selector = settings.selector;

      var eventNamespace = '.' + namespace;
      var moduleNamespace = 'module-' + namespace;

      var observer = this.observer;
      var element = this.element = polymerElement.$.uiCheckbox;

      var $module = this.$module = polymerElement.$.uiCheckbox;
      this.$label = $module.querySelector(selector.label);
      this.$input = $module.querySelector(selector.input);

      this.initialize();

      // end of the function
      return this;
    }

    module.prototype.initialize = function () {
      this.initObjects();

      this.add.events();

      if (this.is.checked()) {
        this.set.checked();
        if (this.settings.fireOnInit) {
          this.settings.onChecked.call(this.$input);
        }
      } else {
        this.remove.checked();
        if (this.settings.fireOnInit) {
          this.settings.onUnchecked.call(this.$input);
        }
      }
      this.observeChanges();
    }

    module.prototype.destroy = function () {
      this.remove.events();
    }

    module.prototype.refresh = function () {
      // this here is module instance; we need this to be the html element
      $module = element;
      $label = element.querySelector(selector.label);
      $input = element.querySelector(selector.input);
    }

    module.prototype.observeChanges = function () {
      if ('MutationObserver' in window) {
        this.observer = new MutationObserver(function (mutations) {
          this.refresh();
        });
        this.observer.observe(this.element, {
          childList: true,
          subtree: true
        });
      }
    }

    module.prototype.initObjects = function () {
        var _self = this;

        this.event = {
          keydown: function (event) {
            var
              key = event.which,
              keyCode = {
                enter: 13,
                space: 32,
                escape: 27
              };
            if (key == keyCode.escape) {
              var blurEvent = document.createEvent('HTMLEvents');
              blurEvent.initEvent('blur', false, false);
              _self.$module.dispatchEvent(blurEvent);
            }
            if (!event.ctrlKey && (key == keyCode.enter || key == keyCode.space)) {
              _self.toggle.call(this);
              event.preventDefault();
            }
          }
        }

        this.is = {
          radio: function () {
            return _self.$module.classList.contains(_self.className.radio);
          },
          checked: function () {
            var checkedAttr = _self.$input.getAttribute('checked');
            return (checkedAttr !== null || checkedAttr !== '') && checkedAttr;
          },
          unchecked: function () {
            return !_self.is.checked();
          }
        }

        this.can = {
          change: function () {
            var hasDisabled = _self.$module.classList.contains(_self.className.disabled);
            var hasReadonly = _self.$module.classList.contains(_self.className.readOnly);
            var hasPropDisabled = _self.$input.getAttribute('disabled');
            return !(hasDisabled || hasReadonly || hasPropDisabled);
          },
          uncheck: function () {
            return (typeof _self.settings.uncheckable === 'boolean') ? _self.settings.uncheckable : !_self.is.radio();
          }
        }

        this.set = {
          checked: function () {
            _self.$module.classList.add(_self.className.checked);
          },
          tab: function () {
            if (_self.$input.getAttribute('tabindex') === undefined) {
              _self.$input.setAttribute('tabindex', 0);
            }
          }
        }

        this.has = {
          label: function () {
            return (_self.$label.length > 0);
          }
        }

        this.add = {
          events: function () {
            _self.$module.addEventListener('click', _self.toggle);
            _self.$input.addEventListener('keydown', _self.event.keydown);
          }
        }

        this.remove = {
          checked: function () {
            _self.$module.classList.remove(_self.className.checked);
          },
          events: function () {
            _self.$module.removeEventListener('click', _self.toggle);
            _self.$input.removeEventListener('keydown', _self.event.keydown);
          }
        }

        this.toggle = function (event) {
          if (!_self.can.change()) {
            return;
          }
          if (_self.is.unchecked()) {
            _self.check();
          } else if (_self.is.checked() && _self.can.uncheck()) {
            _self.uncheck();
          }
        }

      } // end of initObjects

    module.prototype.enable = function () {
      $module.classList.remove(className.disabled);
      $input.removeAttribute('disabled');
      settings.onEnabled.call($input);
    }

    module.prototype.disable = function () {
      this.$module.classList.add(this.className.disabled);
      this.$input.setAttribute('disabled', 'true');
      this.settings.onDisabled.call(this.$input);
    }

    module.prototype.check = function () {
      this.$input.setAttribute('checked', 'true');

      var changeEvent = document.createEvent('HtmlEvents');
      changeEvent.initEvent('change', false, false);
      this.$input.dispatchEvent(changeEvent);

      this.set.checked();

      var blurEvent = document.createEvent('HtmlEvents');
      blurEvent.initEvent('blur', false, false);
      this.$input.dispatchEvent(blurEvent);

      this.settings.onChange.call(this.$input);
      this.settings.onChecked.call(this.$input);
    }

    module.prototype.uncheck = function () {
      this.$input.removeAttribute('checked');

      var changeEvent = document.createEvent('HtmlEvents');
      changeEvent.initEvent('change', false, false);
      this.$input.dispatchEvent(changeEvent);

      this.remove.checked();
      var blurEvent = document.createEvent('HtmlEvents');
      blurEvent.initEvent('blur', false, false);
      this.$input.dispatchEvent(blurEvent);

      this.settings.onChange.call(this.$input);
      this.settings.onUnchecked.call(this.$input);
    }

    // default settings for semantic checkbox
    window.atFormCheckbox.settings = {
      name: 'Checkbox',
      namespace: 'checkbox',

      // delegated event context
      uncheckable: 'auto',
      fireOnInit: true,

      onChange: function () {},
      onChecked: function () {},
      onUnchecked: function () {},
      onEnabled: function () {},
      onDisabled: function () {},

      className: {
        checked: 'checked',
        disabled: 'disabled',
        radio: 'radio',
        readOnly: 'read-only'
      },

      selector: {
        input: 'input[type="checkbox"], input[type="radio"]',
        label: 'label'
      }

    };

  })(window, document, undefined);
</script>